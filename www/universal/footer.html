<footer>

	<div class="panel-group">
		<div class="panel panel-primary">
			<div class="panel-heading">捐款</div>
			<div class="panel-body">

				<div class="row">

					<div class="col-md-6">
						Bitcoin (XBT)
						<div class="input-group">
							<span class="input-group-addon" onclick="copyFunction('xbt_addr')"><i
									class="glyphicon glyphicon-copy"></i></span>
							<input id="xbt_addr" type="text" class="form-control" name="xbt_addr" value="" readonly />
						</div>

					</div>
					<div class="col-md-6">
						Ether (ETH), Polygon (MATIC) or any ERC 20 token
						<div class="input-group">
							<span class="input-group-addon" onclick="copyFunction('eth_addr')"><i
									class="glyphicon glyphicon-copy"></i></span>
							<input id="eth_addr" type="text" class="form-control" name="eth_addr" value="" readonly />
						</div>
					</div>


					<!--<div class="col-md-12">
						Monero (XMR)
						<div class="input-group">
							<span class="input-group-addon" onclick="copyFunction('xmr_addr')"><i
									class="glyphicon glyphicon-copy"></i></span>
							<input id="xmr_addr" type="text" class="form-control" name="xmr_addr" value="" readonly />
						</div>
					</div>-->


				</div><!-- close .row-->

				<br />

				<div class="row">
					<div class="col-md-12 text-center">
						<button id="donate_matic" class="sendEthButton btn">使用 Metamask 捐贈約 HKD 50 的 Ether</button>
					</div>
				</div><!-- close .row-->

			</div>
		</div>
	</div>

</footer>

<script>
	$('#xbt_addr').val('3MSNhVbXQeqBgoT5HngSDLuynNyMkMB2JN');
	$('#eth_addr').val('0x72183156b4F427eFdA8b3ddED1939374e18Da77d');
	$('#xmr_addr').val('42mm8uEv9aPLwGz2cSXwCzRao4XBJFoBGNFYpkBsE8K1amWVEbNmjHfTjtBPVfvgp3KEzrK9T16KxiU8LKYjyvKrSSnsWEg');
	$('.form-control').css('text-overflow', 'ellipsis');

	//donate
	//MetaMask
	if (typeof window.ethereum !== 'undefined') {
		console.log('MetaMask is installed!');//test
		eth_price = 0;
		get_eth_price();
		//if (window.ethereum.networkVersion !== 1) {
		//switch_chain(1);
		//}
		setInterval(function () { get_eth_price(); }, 300000);
	} else {
		$('#donate_matic').css('display', 'none');//disable donate button
	}

	let accounts = [];

	const sendEthButton = document.querySelector('.sendEthButton');
	//Ask to sending native token to an address
	sendEthButton.addEventListener('click', () => {
		//eth_price = 0;
		getAccount().then(
			function () {
				//console.log(eth_price);
				if (window.ethereum.networkVersion !== 1) {
					switch_chain(1);
				}
				if (eth_price > 0) {
					value = (50 / 7.8 / eth_price);
					console.log('value: ' + value);//test
					send_eth(value);
				} else {
					console.log('eth_price: ' + eth_price);//test
				}
			}
		)
	});

	//check MetaMask Chain id
	/*ethereum.on('chainChanged', (chainId) => {
		console.log('chainId: ' + parseInt(chainId, 16));
		switch_chain(1);
	});*/

	function copyFunction(addr) {
		/* Get the text field */
		var copyText = document.getElementById(addr);

		/* Select the text field */
		copyText.select();
		copyText.setSelectionRange(0, 99999);//For mobile devices

		/* Copy the text inside the text field */
		document.execCommand("copy");
		/* Alert the copied text */
		//alert("Copied the text: " + copyText.value);
	}

	async function get_eth_price() {
		var api_link = 'https://ggbrcsnwqc.execute-api.ap-southeast-1.amazonaws.com/quote';

		$.ajax({
			async: false,
			type: 'get',
			url: api_link,
			data: {
				'base': 'USDT',
				'target': 'ETH'
			},
			success: function (data) {
				data = JSON.parse(data);
				console.log(data);

				eth_price = data['result'][0]['price'];
				console.log('set eth_price to: ' + eth_price);//test
			}
		});
	}

	async function send_eth(value) {
		if (!(value > 0)) {
			if (confirm('Fail to get exchange rate, donate ETH 0.01 ?')) {
				value = 0.01;
			} else {
				return;
			}
		}

		if (window.ethereum.networkVersion !== 1) {
			switch_chain(1);
		}

		await ethereum
			.request({
				method: 'eth_sendTransaction',
				params: [
					{
						from: accounts[0],
						to: '0x72183156b4F427eFdA8b3ddED1939374e18Da77d',
						value: parseInt((value) * (Math.pow(10, 18))).toString(16),

						//gas: (21000*(Math.pow(10, 0))).toString(16), //21000 wei
						//gasPrice: (1*(Math.pow(10, 9))).toString(16), //1 Gwei

					},
				],
			})
			.then((txHash) => console.log(txHash))
			.catch((error) => console.error);
	}

	async function getAccount() {
		if (window.ethereum.networkVersion !== 1) {
			switch_chain(1);
		}
		accounts = await ethereum.request({ method: 'eth_requestAccounts' });
		const account = accounts[0];
		//showAccount.innerHTML = account;

	}

	async function switch_chain(target_chain_id) {
		//target_chain_id = 1; //Matic
		console.log('0x' + (target_chain_id.toString(16))); //test
		try {
			await ethereum.request({
				method: 'wallet_switchEthereumChain',
				params: [{ chainId: ('0x' + (target_chain_id.toString(16))) }],
			});
		} catch (switchError) {
			// This error code indicates that the chain has not been added to MetaMask.
			if (switchError.code === 4902) {
				try {
					await ethereum.request({
						method: 'wallet_addEthereumChain',
						params: [{ chainId: ('0x' + (target_chain_id.toString(16))), chainName: 'Polygon', nativeCurrency: { name: 'Polygon', symbol: 'MATIC', decimals: 18 }, rpcUrls: ['https://rpc-mainnet.maticvigil.com/'], blockExplorerUrls: ['https://polygonscan.com/'] }],
					});
				} catch (addError) {
					// handle "add" error
				}
			}
			// handle other "switch" errors
		}
	}
</script>